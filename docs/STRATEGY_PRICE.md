# 가격 전략 (Price Strategy) - Seven Split + Trailing Buy

이 문서는 `backend/strategies/logic_price.py` 파일에 구현된 *가격 전략(Price Strategy)*의 동작 로직을 설명합니다.

## 개요
가격 전략은 자산을 여러 개의 "분할(Split)"로 나누어 투자하는 **그리드 트레이딩(Grid Trading)** 시스템입니다. 가격이 하락하면 분할 매수하여 수량을 모으고(`Buy on Drop`), 각 분할분이 목표 수익률에 도달하면 개별적으로 매도(`Sell on Rise`)합니다.

## 핵심 로직

### 1. 매수 로직 (물타기)

#### A. 일반 그리드 매수 (기본)
`use_trailing_buy` 설정이 **False**일 때 사용하는 기본 방식입니다.

*   **발동 조건**: `현재가(current_price)`가 `다음 매수 목표가(next_buy_level)` 이하로 떨어졌을 때.
    *   `다음 매수 목표가 = 마지막 매수가 * (1 - buy_rate)`
*   **동작**:
    *   현재가에 즉시 지정가 매수 주문을 냅니다.
    *   만약 급락하여 여러 단계를 한 번에 건너뛴 경우, 건너뛴 단계만큼 한꺼번에 매수(`levels_crossed`)합니다.
*   **초기 진입**: 보유한 분할분이 하나도 없다면, 시작 시점에 현재가로 1회 매수합니다.

#### B. Trailing Buy (선택 사항: 폭락 대응)
`use_trailing_buy` 설정이 **True**일 때 사용하며, 급락장에서 RSI 지표를 보고 진입 시점을 조절합니다.

*   **동작 원리**:
    *   **발동**: `현재가 <= 다음 매수 목표가`인 상황에서
    *   **RSI 5분봉 <= 30** (과매도 상태): 아직 하락세가 강하다고 판단하여 매수를 보류하고 **관망(Watching) 상태**로 들어갑니다.
    *   **RSI 5분봉 > 30 (반등 신호) AND 가격 반등 (Rebound)**:
        *   최저가 대비 일정 비율(`trailing_buy_rebound_percent`) 이상 가격이 반등하고,
        *   동시에 RSI도 30 위로 올라와야만 매수를 실행합니다.
        *   두 조건이 모두 충족될 때 그동안 미뤘던 물량을 한꺼번에 매수합니다.

*   **차이점**:
    *   단순히 가격만 올랐다고 사는 게 아니라, RSI 지표가 회복되는 것까지 확인하여 "가짜 반등"에 속을 확률을 줄입니다.
    *   RSI만 올랐다고 사는 게 아니라, 실제 가격도 바닥을 찍고 올라와야 하므로 "바닥 잡기" 효율을 높입니다.

### 2. 매도 로직 (익절)
*   **발동**: 매수 체결 즉시 발동.
*   **동작**: 해당 분할분에 대해 **지정가 매도 주문(Limit Sell)**을 미리 걸어둡니다.
    *   `매도 목표가 = 매수가 * (1 + sell_rate)`
*   **체결**: 시장가가 목표가에 도달하면 거래소에서 체결됩니다.
*   **결과**: 해당 분할분의 상태가 `SELL_FILLED`가 되며, 리스트에서 제거되거나 기록 보관됩니다.

### 3. 재진입 전략 (모든 포지션 청산 후)
보유한 모든 분할분을 매도하여 포지션이 0이 되었을 때의 행동입니다.
*   **전략 1 (`reset_on_clear`)**: 마지막 매수가를 초기화하고, 현재가에 즉시 매수하여 새로운 사이클을 시작합니다.
*   **전략 2 (`last_sell_price`)**: `마지막 매수가 = 마지막 매도가`로 설정합니다. 즉, 내가 판 가격보다 다시 `buy_rate`만큼 떨어져야 재진입합니다. (고점 판독 후 추격 매수 방지)
*   **전략 3 (`last_buy_price`)**: 포지션이 청산되어도 이전의 `마지막 매수가`를 유지합니다. 즉, 이전에 샀던 가격 기준으로 추가 하락이 발생해야만 재진입합니다. (현재가 추격 방지)

## 주요 설정 (Config)
*   **`buy_rate`**: 분할 매수 간격 (예: 0.01 = 1%).
*   **`sell_rate`**: 분할 매도 목표 수익률 (예: 0.01 = 1%).
*   **`min_price` / `max_price`**: 봇이 동작할 최소/최대 가격 범위.
*   **`use_trailing_buy`**: 폭락 대응 로직 사용 여부.
*   **`trailing_buy_rebound_percent`**: 반등 확인 비율 (예: 0.5%).

## 구현 상세
*   **파일**: `backend/strategies/logic_price.py`
*   **클래스**: `PriceStrategyLogic`
*   **의존성**: `backend/strategy.py` (주문 생성, 상태 저장 등 공통 기능 담당)
